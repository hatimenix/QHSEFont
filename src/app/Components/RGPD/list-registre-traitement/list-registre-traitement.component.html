<div class="content-page custom-background">
  <div class="container-fluid">
    <div class="card">
       <div class="row">
           <div class="col-lg-12">
            <div class="card-header d-flex justify-content-between ">
              <div class="header-title">
                <h4 class="card-title">Registre de traitement</h4>
                   </div>
                   <a routerLink="/add-RGPD"  class="btn btn-warning btn-sm add-list" style="color: white; margin-right: -1%;">
                    <i class="las la-plus"></i> Ajouter registe de traitement
                  </a>               
                </div>
           </div>
           </div>
           <div class="card-body">
           <div class="row justify-content-start">
            <div class="input-group mb-4 col-md-4">
              <div class="input-group-prepend">
                <span class="input-group-text">
                  <i class="fas fa-search" style="font-size: 1rem;"></i>
                </span>
              </div>
              <input type="text" class="form-control form-control-sm" placeholder="Chercher" [(ngModel)]="searchQuery" >
              <div class="input-group-append">
                <button class="btn btn-light btn-sm" (click)="resetSearchQuery()">Effacer 
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          
          <div class="dropdown">
            <button class="btn btn-sm dropdown-toggle btn-primary" type="button" id="filterDropdown" data-toggle="dropdown"
              aria-haspopup="true" aria-expanded="false" data-offset="0,5">
              <i class="fas fa-filter"></i>Filtrer par
            </button>
            <div class="dropdown-menu" aria-labelledby="filterDropdown">
              <a class="dropdown-item" (click)="filterByField('typeregistre')" style="cursor: pointer;">Registre</a>
              <a class="dropdown-item" (click)="filterByField('responsable_traitement')" style="cursor: pointer;">Responsable du traitement</a>
              <a class="dropdown-item" (click)="filterByField('nomtraitement')" style="cursor: pointer;">Nom du traitement</a>

            </div>
            <div class="dropdown dropright">
              <div class="popover" role="tooltip" [ngStyle]="{ display: showPopover ? 'block' : 'none' }" data-placement="right"  >
                <div class="arrow"></div>
                <button type="button" class="close" aria-label="Close" (click)="closePopover()">
                  <span aria-hidden="true">&times;</span>
                </button>
                <div class="popover-body" style="width: 500px; max-width: 100%;">
                  <div class="input-group mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text">
                        <i class="fas fa-search"></i>
                      </span>
                    </div>
                    <input type="text" class="form-control form-control-sm" [(ngModel)]="fieldSearchQuery" (input)="applyFieldFilter()">
                  </div>
                
                  <div class="row justify-content-center">
                    <div class="col-md-12">
                      <div class="alert alert-info" role="alert" *ngIf="filterField && filteredTraitements.length === 0">
                        Aucun résultat.
                      </div>
                    </div>
                  </div>
                
                  <div class="row justify-content-end">
                    <div class="col-md-4">
                      <button class="btn" (click)="handleReset()">Fermer</button>
                    </div>
                  </div>
                </div>
              </div>
           </div>
          </div>
        </div> 
        
        <div class="row">
          <div class="col-md-5">
            <div class="form-group">
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">Depuis :</span>
                </div>
                <input type="date" class="form-control" id="start_date" [(ngModel)]="startDate">
              </div>
            </div>
          </div>
          <div class="col-md-5">
            <div class="form-group">
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">Vers :</span>
                </div>
                <input type="date" class="form-control" id="end_date" [(ngModel)]="endDate">
              </div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="row justify-content-center">
              <div class="input-group">
                <div class="input-group-append">
                  <button style="margin-top: 1.5%;" class="btn btn-primary" (click)="filterByDateCreation()">
                    <i class="fas fa-filter"></i> Filter par date
                  </button>
                  <button style="margin-top: 1.5%;" class="btn btn-light" (click)="resetDateFilter()">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
           
             <div>
              <div class="row justify-content-between">
                <div>
                  <button class="btn" (click)="filterByTypeRegistre()">Traitements par registre</button>
                  <button class="btn" (click)="filterByRespRegistre()">Registre par responsable de traitement</button>
                </div>
              
                <div class="dropdown">
                  <button class="btn btn-sm dropdown-toggle" type="button" id="itemsPerPageDropdown" data-toggle="dropdown"
                    aria-haspopup="true" aria-expanded="false">
                    Afficher {{ itemsPerPage }} résultats par page
                  </button>
                  <div class="dropdown-menu" aria-labelledby="itemsPerPageDropdown">
                    <a class="dropdown-item" style="cursor: pointer;" *ngFor="let option of itemsPerPageOptions" (click)="onItemsPerPageChange(option)"
                      [ngClass]="{'selected': option === itemsPerPage}">
                      <span>{{ option }}</span>
                      <i style="margin-left: 1%;" class="fas fa-check" *ngIf="option === itemsPerPage"></i>
                    </a>
                  </div>
                </div>
              </div>
              

                <div class="col-lg-12">
                    <div class="table-responsive rounded mb-3">
                    <table class="data-tables table mb-0 tbl-server-info">
                        <thead>
                            <tr class=" ligth-data">
                              <th scope="col" *ngIf="showTypeRegistre">Registre</th>
                                <th scope="col" *ngIf="showRespRegistre">Responsable du traitement</th>
                                <th>Ref traitement</th>
                                <th>Nom du traitement</th>
                                <th>Date de creation</th>
                                <th>date de mise a jour</th>
                                <th>Donnee sensibles</th>
                                <th>Personne Concernee</th>
                                <th>Precisions</th>
                                <th style="min-width: 100px">Action</th>
                                <th scope="col">Supprimer les colonnes</th>

                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let traitement of displayedTraitements | filter : searchQuery let i = index" [ngClass]="{'table-primary': i % 2 == 0, 'table-default': i % 2 == 1 }  ">
                              <td *ngIf="showTypeRegistre"><a routerLink="/traitement/{{ traitement.id }}">{{traitement.typeregistre}}</a></td>
                              <td *ngIf="showRespRegistre">{{traitement.responsable_traitement}}</td>
                              <td>{{traitement.id}}</td>
                              <td>{{traitement.nomtraitement}}</td>
                                <td>{{ traitement.datedecreation | date:'yyyy-MM-dd' }}</td>
                                <td>{{traitement.datedemiseajour | date:'yyyy-MM-dd'}}</td>
                                <td>{{traitement.donneesensible ? 'Oui' : 'Non'}}</td>
                                <td>{{traitement.personneconcernees}}</td>
                                <td>{{traitement.precision}}</td>
                                <td>
                                  <div class="d-flex justify-content-start align-items-center list-action">
                                    <a class="badge bg-success mr-2" style="cursor: pointer;" (click)="getTraitementData(traitement.id , traitement.fournisseur, traitement.typeregistre, traitement.nomtraitement,traitement.description_generale,traitement.datedecreation,traitement.datedemiseajour,traitement.responsable_traitement,traitement.finaliteprincipale,traitement.sous_finalite1,traitement.sous_finalite2,traitement.sous_finalite3,traitement.sous_finalite4,traitement.donneesensible,traitement.type_donnee,traitement.categorie,traitement.description,traitement.dureedeconcesrvation,traitement.personneconcernees,traitement.precisions,traitement.typedestinataire,traitement.precision,traitement.donneeconcernees,traitement.mtypedemesuredesecurite,traitement.destinataire,traitement.pays,traitement.typedegarantie,traitement.lienversladocumentation,traitement.lesdonneesconcernee,traitement.fournisseur_dpo,traitement.fournisseur_representant)" data-toggle="modal" data-target="#update" data-placement="top" title="" data-original-title="Edit"
                                          ><i class="ri-pencil-line mr-0"></i></a>
                                          <a class="badge btn-warning mr-2" style="cursor: pointer;" data-toggle="tooltip" (click)="openDeleteModal(traitement.id)" data-placement="top" title="" data-original-title="Delete">
                                            <i class="ri-delete-bin-line mr-0"></i>
                                          </a>
                                  </div>
                              </td>
                              <td>
                                <input type="checkbox" [checked]="selectedTraitements.includes(traitement)" (change)="toggleSelection(traitement)">
                              </td>
                            </tr>
                        </tbody> 
                    </table>
                </div>
                <div class="pagination-container" style="display: flex; justify-content: space-between;">
                  <div>
                    <span class="entry-info">
                      {{ getDisplayedRange() }}
                    </span>
                  </div>
                  <div style="display: flex;justify-content: flex-end;">
                    <button class="btn" [disabled]="p === 1" (click)="p = p - 1">Précedent</button>
                    <div class="page-info">
                      <span class="page-numbers">
                        <button class="btn page-number" *ngFor="let page of getPageNumbers()" [disabled]="p === page" (click)="p = page" [ngClass]="{'selected': p === page}">{{ page }}</button>
                      </span>
                    </div>
                    <button class="btn" [disabled]="p === totalPages" (click)="p = p + 1">Suivant</button>
                  </div>
                </div>          
              </div>
              </div>
              </div>
       <!-- Page end  -->
<!-- Modal -->
<div class="modal fade" id="delete" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
aria-hidden="true">
<div class="modal-dialog" role="document">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="exampleModalLabel">Avertissement</h5>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body">
      Attention , cette action est irréversible !
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-primary" (click)="deleteItem()" ><i class="fas fa-trash"></i>Supprimer</button>
      <button type="button" class="btn btn-warning" data-dismiss="modal"><i class="fas fa-times"></i>Fermer</button>
    </div>
  </div>
</div>
</div>
<!-- Modal -->
<div class="modal fade" [class.show]="updateModalVisible" id="update" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div>
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Modifier un registre de traitement</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>


        <div class="modal-body">
          <form [formGroup]="form" data-toggle="validator">
            <div class="row">
                <div class="col-md-3">                      
                    <div class="form-group">
                        <label> Registre </label>
                        <input [(ngModel)]="typeregistre" type="text" value="{{typeregistre}}" formControlName="typeregistre" class="form-control" data-errors="Please Enter Name." id="typeregistre" >
                     </div>
                 </div>
                 <div class="col-md-3">                      
                    <div class="form-group">
                        <label>Nom du traitement </label>
                        <input [(ngModel)]="nomtraitement" value="{{nomtraitement}}" type="text" formControlName="nomtraitement" class="form-control" data-errors="Please Enter Name." id="nomtraitement" >
                     </div>
                 </div>
                 <div class="col-md-3">                      
                    <div class="form-group">
                        <label>Description générale </label>
                        <input [(ngModel)]="description_generale" value="{{description_generale}}"  type="text" formControlName="description_generale" class="form-control"  data-errors="Please Enter Name." id="description_generale" >
                     </div>
                 </div>
                 <div class="col-md-3">                      
                    <div class="form-group">
                        <label title="Société du responsable du traitement">SDRT </label>
                        <select [(ngModel)]="fournisseur" id="fournisseur" name="fournisseur" style="width: 100%;" formControlName="fournisseur" class="form-control" class="custom-select" >
                          <option *ngFor="let fournisseur of fournisseurs" [value]="fournisseur.id">{{ fournisseur.nom }}</option>
                        </select>
                      </div>
                 </div>
                 </div>
                 <div class="row">
                 <div class="col-md-3">                      
                    <div class="form-group">
                        <label>Société du DPO </label>
                        <select [(ngModel)]="fournisseur_dpo" id="fournisseur_dpo" name="fournisseur_dpo" style="width: 100%;" formControlName="fournisseur_dpo" class="form-control" class="custom-select" >
                          <option *ngFor="let fournisseur of fournisseurs" [value]="fournisseur.id">{{ fournisseur.nom }}</option>
                        </select>                     
                      </div>
                     </div>
                 <div class="col-md-3">                      
                    <div class="form-group">
                        <label title="Société du représentant dans l'UE">SRDU</label>
                        <select [(ngModel)]="fournisseur_representant" id="fournisseur_representant" name="fournisseur_representant" style="width: 100%;" formControlName="fournisseur_representant" class="form-control" class="custom-select" >
                          <option *ngFor="let fournisseur of fournisseurs" [value]="fournisseur.id">{{ fournisseur.nom }}</option>
                        </select>                    
                       </div>
                 </div>
                 <div class="col-md-3">                      
                    <div class="form-group">
                        <label>Responsable Traitement</label>
                        <input [(ngModel)]="responsable_traitement" type="text" value="{{responsable_traitement}}" formControlName="responsable_traitement" class="form-control"  data-errors="Please Enter Name." id="responsable_traitement" >
                     </div>
                 </div>
                 <div class="col-md-3">                      
                    <div class="form-group">
                        <label>Finalité principale</label>
                        <input [(ngModel)]="finaliteprincipale" type="text" value="{{finaliteprincipale}}" formControlName="finaliteprincipale" class="form-control"  data-errors="Please Enter Name." id="finaliteprincipale" >
                     </div>
                 </div>
                 </div>
                 <div class="row">
                 <div class="col-md-3">                      
                    <div class="form-group">
                        <label>Sous finalité 1</label>
                        <input [(ngModel)]="sous_finalite1" type="text" value="{{sous_finalite1}}" formControlName="sous_finalite1" class="form-control"  data-errors="Please Enter Name." id="sous_finalite1" >
                     </div>
                 </div>
                 <div class="col-md-3">                      
                    <div class="form-group">
                        <label>Sous finalité 2</label>
                        <input [(ngModel)]="sous_finalite2" type="text" value="{{sous_finalite2}}" formControlName="sous_finalite2" class="form-control"  data-errors="Please Enter Name." id="sous_finalite2" >
                     </div>
                 </div>
                 <div class="col-md-3">                      
                    <div class="form-group">
                        <label>Sous finalité 3</label>
                        <input [(ngModel)]="sous_finalite3" type="text" value="{{sous_finalite3}}" formControlName="sous_finalite3" class="form-control"  data-errors="Please Enter Name." id="sous_finalite3" >
                     </div>
                 </div>
                 <div class="col-md-3">                      
                    <div class="form-group">
                        <label>Sous finalité 4</label>
                        <input [(ngModel)]="sous_finalite4" type="text" value="{{sous_finalite4}}" formControlName="sous_finalite4" class="form-control"  data-errors="Please Enter Name." id="sous_finalite4" >
                     </div>
                 </div>
                 </div>
                 <div class="row">
                 <div class="col-md-3">                      
                    <div class="form-group">
                        <label>Donnée sensible</label>
                        <select [(ngModel)]="donneesensible" id="donneesensible" formControlName="donneesensible"  class="custom-select" data-style="py-0">
                          <option [ngValue]="true">Oui</option>
                          <option [ngValue]="false">Non</option>
                      </select>                     
                    </div>
                 </div>
                 <div class="col-md-3">                      
                    <div class="form-group">
                        <label>Type de donne</label>
                        <input [(ngModel)]="type_donnee" type="text" value="{{type_donnee}}" formControlName="type_donnee" class="form-control"  data-errors="Please Enter Name." id="type_donnee" >
                     </div>
                 </div>
                 <div class="col-md-3">                      
                    <div class="form-group">
                        <label>Catégorie</label>
                        <select [(ngModel)]="categorie" value="{{categorie}}" id="categorie"
                        formControlName="categorie" class="form-control" class="custom-select">
                        <option >DP:Etat civil,identité,donnée d'identification,images...</option>
                          <option >DP:Vie perso(habitudes de vie,situation familiale,etc,)</option>
                          <option >DP:Info d'ordre éco et financier (revenus,financière,sit,fiscale,etc,)</option>
                          <option >DP:Données de connexion (adresse IP,logs,etc,)</option>
                          <option >DP:Données de localisation (déplacements,Géoloc,GSM,etc,)</option>
                          <option >DP:Numéro de Sécurité Sociale(ou NIR)</option>
                          <option >DS:Données révelant l'origine raciale ou ethnique</option>
                          <option >DS:Données révélant les opinions politiques</option>
                          <option >DS:Données révélant les convictions religieuses ou philisophiques</option>
                          <option >DS: Données révélant l'appartenance syndicale</option>
                          <option >DS: Données génétiques</option>
                          <option >DS: Données biométriques aux fins d'identifier une per.physique de manière unique</option>
                          <option >DS: Données concernant la santé</option>
                          <option >DS: Données concernant la vie ou l'orientation sexuelle</option>
                          <option >DS: Données relatives à des condamnations pénales ou infractions</option>
                      </select>                     
                    </div>
                 </div>
                 <div class="col-md-3">                      
                    <div class="form-group">
                        <label>Description</label>
                        <input [(ngModel)]="description" value="{{description}}" type="text" formControlName="description" class="form-control" data-errors="Please Enter Name." id="description" >
                     </div>
                 </div>
                 </div>
                 <div class="row">
                  <div class="col-md-3">                      
                  <div class="form-group">
                      <label>Durée de conservation </label>
                      <input [(ngModel)]="dureedeconcesrvation" value="{{dureedeconcesrvation}}" type="text" formControlName="dureedeconcesrvation" class="form-control"  data-errors="Please Enter Name." id="dureedeconcesrvation" >
                   </div>
               </div>
               <div class="col-md-3">                      
                <div class="form-group">
                    <label>Personnes concernés </label>
                    <select [(ngModel)]="personneconcernees" value="{{personneconcernees}}" id="personneconcernees"
                    formControlName="personneconcernees" class="form-control" class="custom-select">
                    <option >DP:Etat civil,identité,donnée d'identification,images...</option>
                    <option >salariés</option>
                    <option >Services internes</option>
                    <option >Clients</option>
                    <option >Fournisseurs</option>
                    <option >Prestataires</option>
                    <option >Prospects</option>
                    <option >Candidats</option>
                    <option >Partenaires</option>
                  </select>                 
                </div>
             </div>
             <div class="col-md-3">                      
              <div class="form-group">
                  <label>Précisions </label>
                  <input [(ngModel)]="precisions" value="{{precisions}}" type="text" formControlName="precisions" class="form-control"  data-errors="Please Enter Name." id="precisions" >
               </div>
           </div>
           <div class="col-md-3">                      
            <div class="form-group">
                <label>Type de destinataire </label>
                <select [(ngModel)]="typedestinataire" value="{{typedestinataire}}" id="typedestinataire"
                formControlName="typedestinataire" class="form-control" class="custom-select">
                <option >Service interne qui traite les données</option>
                          <option >Sous traitant</option>
                          <option >Destinataire dans des pays tiers ou organisations internationales</option>
                          <option >Partenaires institutionnels ou commerciaux</option>
              </select>             
            </div>
         </div>
                 </div>
                 <div class="row">
                  <div class="col-md-3">                      
                    <div class="form-group">
                        <label>Données concernées </label>
                        <input [(ngModel)]="donneeconcernees" value="{{donneeconcernees}}" type="text" formControlName="donneeconcernees" class="form-control"  data-errors="Please Enter Name." id="donneeconcernees" >
                     </div>
                 </div>
                 <div class="col-md-3">                      
                  <div class="form-group">
                      <label>Type de mesure de sécurité </label>
                      <select [(ngModel)]="mtypedemesuredesecurite" value="{{mtypedemesuredesecurite}}" id="mtypedemesuredesecurite"
                      formControlName="mtypedemesuredesecurite" class="form-control" class="custom-select">
                      <option >Mesures de tracibilité</option>
                          <option >Mesures de protection des logiciels</option>
                          <option >Sauvegarde de données</option>
                          <option >Chiffrement de données</option>
                          <option >Contrôle d'accés des utilisateurs</option>
                          <option >Contrôle des sous-traitants</option>
                          <option >Autres mesures (à préciser)</option>
                    </select>                     
                  </div>
               </div>
               <div class="col-md-3">                      
                <div class="form-group">
                    <label>Destinataire </label>
                    <input [(ngModel)]="destinataire" value="{{destinataire}}" type="text" formControlName="destinataire" class="form-control"  data-errors="Please Enter Name." id="destinataire" >
                 </div>
             </div>
             <div class="col-md-3">                      
              <div class="form-group">
                  <label>Pays </label>
                  <select [(ngModel)]="pays" value="{{pays}}" id="pays"
                  formControlName="pays" class="form-control" class="custom-select">
                  <option >Andorre</option>
                          <option >Argentine</option>
                          <option >Canada</option>
                          <option >Etats-Unis</option>
                          <option >Guernessey</option>
                          <option >Ile de Man</option>
                          <option >Iles FEROE</option>
                          <option >Israël</option>
                          <option >Jersey</option>
                          <option >Nouvelle-Zélande</option>
                          <option >Suisse</option>
                          <option >Uruguay</option>
                          <option >Autre pays sans accord RGPD</option>
                </select>                 
              </div>
           </div>
            </div>
            <div class="row">
              <div class="col-md-3">                      
                <div class="form-group">
                    <label>Lien vers la documentation </label>
                    <input [(ngModel)]="lienversladocumentation" value="{{lienversladocumentation}}" type="text" formControlName="lienversladocumentation" class="form-control"  data-errors="Please Enter Name." id="lienversladocumentation" >
                 </div>
    
                     </div>
                     <div class="col-md-3">                      
                      <div class="form-group">
                          <label>Données concernées </label>
                          <input [(ngModel)]="lesdonneesconcernee" value="{{lesdonneesconcernee}}" type="text" formControlName="lesdonneesconcernee" class="form-control"  data-errors="Please Enter Name." id="lesdonneesconcernee" >
                       </div>
                       </div>
                       <div class="col-md-3">                      
                        <div class="form-group">
                            <label>Précisions </label>
                            <input [(ngModel)]="precision" value="{{precision}}" type="text" formControlName="precision" class="form-control"  data-errors="Please Enter Name." id="precision" >
                         </div>
                     </div>
                     <div class="col-md-3">                      
                      <div class="form-group">
                          <label>Type de garantie </label>
                          <select [(ngModel)]="typedegarantie" value="{{typedegarantie}}" id="typedegarantie"
                          formControlName="typedegarantie" class="form-control" class="custom-select">
                          <option >Clauses contractuelles types (CCT)</option>
                          <option >Régles d'entreprise contraignates(BCR)</option>
                          <option >Pays adéquat</option>
                          <option >Privacy shield</option>
                          <option >Code de conduite</option>
                          <option >Certification</option>
                          <option >Dérogations (art 49)</option>
                        </select>                        
                      </div>
          
                           </div>
          
                           </div>
              
        </form>
                              </div>
                              </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-primary" (click)="updatetraitement()"><i class="fas fa-pencil-alt"></i> Modifier</button> 
          <button type="button" class="btn btn-warning" data-dismiss="modal"><i class="fas fa-times"></i> Fermer</button>
        </div>
      </div>
    </div>
  </div>
</div>
</div> 
<!-- Page end  -->
<ng-template #successModal>
  <div class="modal-header">
    <h4 class="modal-title">Succès</h4>
    <button type="button" class="close" aria-label="Close" (click)="closeModal()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    Le registre de traitement a été modifié avec succès.
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="closeModal()">Fermer</button>
  </div>
</ng-template>